<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Agregar Publicación</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f2f4f8;
      padding: 40px 20px;
      max-width: 1200px;
      margin: auto;
      color: #333;
    }

    h2 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 28px;
      color: #222;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .campo {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    input, select, textarea, button {
      font-family: inherit;
    }

    input, select, textarea {
      padding: 12px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      width: 100%;
      background-color: white;
    }

    textarea {
      grid-column: span 2;
      min-height: 100px;
      resize: vertical;
    }

    button {
      padding: 12px 24px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;    
    }

    button:hover {
      background-color: #0056b3;
    }

    .mensaje {
      text-align: center;
      font-weight: bold;
      font-size: 16px;
      margin-top: 10px;
    }

    @media (max-width: 768px) {
      .campo {
        grid-template-columns: 1fr;
      }
      textarea {
        grid-column: span 1;
      }
    }

    /* ====== Autores UI ====== */
    .autores-box {
      border: 1px solid #ddd; 
      padding: 12px; 
      border-radius: 6px; 
      margin-bottom: 16px; 
      background: #fff;
    }
    .sugerencias {
      border: 1px solid #eee; 
      max-height: 200px; 
      overflow: auto; 
      display: none; 
      margin-top: 6px; 
      border-radius: 6px; 
      background: #fff;
    }
    .sug-item {
      padding: 8px 10px; 
      cursor: pointer; 
      border-bottom: 1px solid #f5f5f5;
    }
    .sug-item:hover { background: #f3f8ff; }
    .chips {
      display: flex; 
      gap: 8px; 
      flex-wrap: wrap; 
      margin-top: 8px;
    }
    .chip {
      display: inline-flex; 
      align-items: center; 
      gap: 6px; 
      padding: 6px 8px; 
      border: 1px solid #ddd; 
      border-radius: 20px; 
      background: #fafafa;
    }
    .chip button {
      background: #eee; 
      color: #333; 
      border-radius: 12px; 
      padding: 2px 8px;
    }
    .chip button:hover { background: #ddd; }

    /* Modal */
    .modal-bg {
      display: none; 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,.35); 
      align-items: center; 
      justify-content: center; 
      z-index: 9999;
    }
    .modal-card {
      background: #fff; 
      padding: 16px; 
      width: 520px; 
      max-width: 95%; 
      border-radius: 8px; 
      box-shadow: 0 10px 30px rgba(0,0,0,.15);
    }
    .modal-grid {
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 10px;
    }
    .modal-actions {
      display: flex; 
      gap: 8px; 
      margin-top: 12px; 
      justify-content: flex-end;
    }
    .btn-ghost {
      background: #fff; 
      color: #333; 
      border: 1px solid #ddd;
    }
    .btn-ghost:hover { background: #f6f6f6; }
  </style>
</head>
<body>
  <h2>📚 Registrar Nueva Publicación</h2>

  <form id="formPublicacion">
    <input name="codigo_publicacion" id="codigo_publicacion" placeholder="Código por Publicación" readonly>

    <!-- ======= CAMPOS PUBLICACION ======= -->
    <div class="campo">
      <input id="titulo_libro" name="titulo_libro" placeholder="Título del libro" required>
      <input id="subtitulo" name="subtitulo" placeholder="Subtítulo">
    </div>

    <div class="campo">
      <input name="isbn" id="isbn" placeholder="ISBN">
      <input name="isbn2" id="isbn2" placeholder="ISBN2">
    </div>

    <div class="campo">
      <input name="eisbn" id="eisbn" placeholder="eISBN">
      <input name="eisbn2" id="eisbn2" placeholder="eISBN2">
    </div>

    <div class="campo">
      <input id="doi_libro" name="doi_libro" placeholder="DOI libro">
      <input id="doi_capitulo" name="doi_capitulo" placeholder="DOI capítulo">
    </div>

    <div class="campo">
      <input id="registro_dinda" name="registro_dinda" placeholder="Número de registro de DINDA">
      <input id="titulo_capitulo" name="titulo_capitulo" placeholder="Título de capítulo">
    </div>

    <div class="campo">
      <input id="anio" name="anio" placeholder="Año de publicación">
      <input id="mes" name="mes" placeholder="Mes de publicación">
    </div>

    <input type="date" id="fecha" name="fecha" placeholder="Fecha de publicación">

    <!-- ======= AUTORES ======= -->
    <section class="autores-box">
      <h3 style="margin:0 0 10px;">👤 Autores de la publicación</h3>
      <label for="buscadorAutor"><strong>Buscar autor por cédula o nombre</strong></label>
      <input id="buscadorAutor" type="text" placeholder="Ej: 1020..., o 'Juan Pérez'" />

      <div id="sugerenciasAutores" class="sugerencias"></div>

      <div style="margin-top: 8px;">
        <small>Autores seleccionados:</small>
        <div id="autoresSeleccionados" class="chips"></div>
      </div>

      <div style="margin-top: 10px;">
        <button type="button" id="btnAbrirNuevoAutor" class="btn-ghost" style="background:#fff;color:#007BFF;border:1px solid #c2defe">+ Agregar autor nuevo</button>
      </div>
    </section>

    <button type="submit">Guardar Publicación</button>
    <div class="mensaje" id="mensaje"></div>
  </form>

  <div style="text-align: center; margin-top: 20px;">
    <button type="button" onclick="window.location.href='/'">
      Volver al inicio
    </button>
  </div>

  <!-- ===== Modal Nuevo Autor ===== -->
  <div id="modalNuevoAutor" class="modal-bg">
    <div class="modal-card">
      <h4 style="margin-top:0;">Nuevo autor</h4>
      <div class="modal-grid">
        <div>
          <label>Documento</label>
          <input id="na_documento" type="text" placeholder="Cédula o documento">
        </div>
        <div>
          <label>Nombre completo</label>
          <input id="na_nombre" type="text" placeholder="Nombre y apellidos">
        </div>
        <div>
          <label>Correo</label>
          <input id="na_correo" type="email" placeholder="correo@dominio.com">
        </div>
        <div>
          <label>País</label>
          <input id="na_pais" type="text" placeholder="Colombia">
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" id="btnCancelarAutor" class="btn-ghost">Cancelar</button>
        <button type="button" id="btnGuardarAutor">Guardar autor</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const el = (html) => { const tmp = document.createElement('div'); tmp.innerHTML = html.trim(); return tmp.firstChild; };
    const debounce = (fn, ms=350) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), ms); }; };

    const buscador = $("#buscadorAutor");
    const panelSug = $("#sugerenciasAutores");
    const contChips = $("#autoresSeleccionados");
    const autoresSel = new Map();

    function renderChips(){
      contChips.innerHTML = "";
      for (const a of autoresSel.values()){
        const chip = el(`
          <span class="chip">
            <strong>${a.nombre}</strong> <small>(${a.documento})</small>
            <button type="button">x</button>
          </span>
        `);
        chip.querySelector("button").addEventListener("click", () => {
          autoresSel.delete(a.documento);
          renderChips();
        });
        contChips.appendChild(chip);
      }
    }

    async function buscarAutores(q){
      if(!q || q.length < 2){
        panelSug.style.display = "none";
        panelSug.innerHTML = "";
        return;
      }
      try{
        // 🔹 CORREGIDO: antes llamaba "/buscar"
        const r = await fetch(`/api/autores?q=${encodeURIComponent(q)}`);
        const data = await r.json();
        panelSug.innerHTML = "";

        const normalizados = (Array.isArray(data) ? data : []).map(item => {
          return { documento: item.documento || "", nombre: item.nombre || "" };
        }).filter(x => x.documento && x.nombre);

        if(!normalizados.length){
          panelSug.style.display = "none";
          return;
        }
        normalizados.forEach(a => {
          const item = el(`<div class="sug-item">${a.documento} - ${a.nombre}</div>`);
          item.addEventListener("click", () => {
            autoresSel.set(a.documento, a);
            renderChips();
            panelSug.style.display = "none";
            buscador.value = "";
          });
          panelSug.appendChild(item);
        });
        panelSug.style.display = "block";
      }catch(e){
        console.error("Error buscando autores", e);
        panelSug.style.display = "none";
      }
    }

    buscador.addEventListener("input", debounce(() => buscarAutores(buscador.value.trim()), 300));
    document.addEventListener("click", (e) => {
      if(!panelSug.contains(e.target) && e.target !== buscador){
        panelSug.style.display = "none";
      }
    });
  </script>
</body>
</html>
