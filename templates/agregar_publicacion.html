<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Agregar Publicaci√≥n</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f2f4f8;
      padding: 40px 20px;
      max-width: 1200px;
      margin: auto;
      color: #333;
    }

    h2 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 28px;
      color: #222;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .campo {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    input, select, textarea, button {
      font-family: inherit;
    }

    input, select, textarea {
      padding: 12px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      width: 100%;
      background-color: white;
    }

    textarea {
      grid-column: span 2;
      min-height: 100px;
      resize: vertical;
    }

    button {
      padding: 12px 24px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;    
    }

    button:hover {
      background-color: #0056b3;
    }

    .mensaje {
      text-align: center;
      font-weight: bold;
      font-size: 16px;
      margin-top: 10px;
    }

    @media (max-width: 768px) {
      .campo {
        grid-template-columns: 1fr;
      }
      textarea {
        grid-column: span 1;
      }
    }

    /* ====== Autores UI ====== */
    .autores-box {
      border: 1px solid #ddd; 
      padding: 12px; 
      border-radius: 6px; 
      margin-bottom: 16px; 
      background: #fff;
    }
    .sugerencias {
      border: 1px solid #eee; 
      max-height: 200px; 
      overflow: auto; 
      display: none; 
      margin-top: 6px; 
      border-radius: 6px; 
      background: #fff;
    }
    .sug-item {
      padding: 8px 10px; 
      cursor: pointer; 
      border-bottom: 1px solid #f5f5f5;
    }
    .sug-item:hover { background: #f3f8ff; }
    .chips {
      display: flex; 
      gap: 8px; 
      flex-wrap: wrap; 
      margin-top: 8px;
    }
    .chip {
      display: inline-flex; 
      align-items: center; 
      gap: 6px; 
      padding: 6px 8px; 
      border: 1px solid #ddd; 
      border-radius: 20px; 
      background: #fafafa;
    }
    .chip button {
      background: #eee; 
      color: #333; 
      border-radius: 12px; 
      padding: 2px 8px;
    }
    .chip button:hover { background: #ddd; }

    /* ====== Modal ====== */
    .modal-bg {
      display: none; 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,.35); 
      align-items: center; 
      justify-content: center; 
      z-index: 9999;
    }
    .modal-card {
      background: #fff; 
      padding: 16px; 
      width: 520px; 
      max-width: 95%; 
      border-radius: 8px; 
      box-shadow: 0 10px 30px rgba(0,0,0,.15);
      max-height: 90vh; 
      overflow-y: auto;
    }
    .modal-grid {
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 10px;
    }
    .modal-actions {
      display: flex; 
      gap: 8px; 
      margin-top: 12px; 
      justify-content: flex-end;
    }
    .btn-ghost {
      background: #fff; 
      color: #333; 
      border: 1px solid #ddd;
    }
    .btn-ghost:hover { background: #f6f6f6; }
  </style>
</head>
<body>
  <h2>üìö Registrar Nueva Publicaci√≥n</h2>

  <form id="formPublicacion">
    <input name="codigo_publicacion" id="codigo_publicacion" placeholder="C√≥digo por Publicaci√≥n" readonly>

    <div class="campo">
      <input id="titulo_libro" name="titulo_libro" placeholder="T√≠tulo del libro" required>
      <input id="subtitulo" name="subtitulo" placeholder="Subt√≠tulo">
    </div>

    <div class="campo">
      <input name="isbn" id="isbn" placeholder="ISBN">
      <input name="isbn2" id="isbn2" placeholder="ISBN2">
    </div>

    <div class="campo">
      <input name="eisbn" id="eisbn" placeholder="eISBN">
      <input name="eisbn2" id="eisbn2" placeholder="eISBN2">
    </div>

    <div class="campo">
      <input id="doi_libro" name="doi_libro" placeholder="DOI libro">
      <input id="doi_capitulo" name="doi_capitulo" placeholder="DOI cap√≠tulo">
    </div>

    <div class="campo">
      <input id="registro_dinda" name="registro_dinda" placeholder="N√∫mero de registro de DINDA">
      <input id="titulo_capitulo" name="titulo_capitulo" placeholder="T√≠tulo de cap√≠tulo">
    </div>

    <div class="campo">
      <input id="anio" name="anio" placeholder="A√±o de publicaci√≥n">
      <input id="mes" name="mes" placeholder="Mes de publicaci√≥n">
    </div>

    <input type="date" id="fecha" name="fecha" placeholder="Fecha de publicaci√≥n">

    <div class="campo">
      <input id="nombre_proyecto" name="nombre_proyecto" placeholder="Nombre del proyecto">
      <input id="codigo_proyecto" name="codigo_proyecto" placeholder="C√≥digo del proyecto">
    </div>

    <div class="campo">
      <input id="financiador" name="financiador" placeholder="Financiador del proyecto (si aplica)">
      <input id="linea_editorial" name="linea_editorial" placeholder="L√≠nea editorial">
    </div>

    <div class="campo">
      <input id="tipologia" name="tipologia" placeholder="Tipolog√≠a">
      <input id="thema" name="thema" placeholder="Thema">
    </div>

    <div class="campo">
      <input id="area_conocimiento" name="area_conocimiento" placeholder="√Årea de conocimiento">
      <input id="materia" name="materia" placeholder="Materia">
    </div>

    <div class="campo">
      <input id="palabras_clave" name="palabras_clave" placeholder="Palabras clave">
      <input id="nombre_coleccion" name="nombre_coleccion" placeholder="Nombre Colecci√≥n">
    </div>

    <div class="campo">
      <input id="isbn_issn_coleccion" name="isbn_issn_coleccion" placeholder="ISBN/ISSN Colecci√≥n">
      <input id="formato" name="formato" placeholder="Formato">
    </div>

    <div class="campo">
      <input id="url_repositorio" name="url_repositorio" placeholder="URL repositorio">
      <input id="idioma" name="idioma" placeholder="Idioma">
    </div>

    <textarea id="resumen" name="resumen" placeholder="Resumen (60 palabras)"></textarea>

    <div class="campo">
      <input id="ods" name="ods" placeholder="Objetivo desarrollo sostenible">
      <input id="rectoria_normalizada" name="rectoria_normalizada" placeholder="SEDE">
    </div>

    <div class="campo">
      <input id="centro_universitario" name="centro_universitario" placeholder="Centro Universitario">
      <input id="origen" name="origen" placeholder="Origen">
      <input type="text" name="origen_otro" id="origen_otro" placeholder="Especificar otro origen" style="display:none;" />
    </div>

    <div class="campo">
      <input type="date" id="fecha_diligenciamiento" name="fecha_diligenciamiento" placeholder="Fecha de publicaci√≥n">
    </div>

    <!-- ======== BLOQUE NUEVO: RELACIONAR AUTORES ======== -->
    <section class="autores-box">
      <h3 style="margin:0 0 10px;">üë§ Autores de la publicaci√≥n</h3>
      <label for="buscadorAutor"><strong>Buscar autor por c√©dula o nombre</strong></label>
      <input id="buscadorAutor" type="text" placeholder="Ej: 1020..., o 'Juan P√©rez'" />

      <div id="sugerenciasAutores" class="sugerencias"></div>

      <div style="margin-top: 8px;">
        <small>Autores seleccionados:</small>
        <div id="autoresSeleccionados" class="chips"></div>
      </div>

      <div style="margin-top: 10px;">
        <button type="button" id="btnAbrirNuevoAutor" class="btn-ghost" style="background:#fff;color:#007BFF;border:1px solid #c2defe">+ Agregar autor nuevo</button>
      </div>
    </section>
    <!-- =================================================== -->

    <button type="submit">Guardar Publicaci√≥n</button>
    <div class="mensaje" id="mensaje"></div>
  </form>

  <div style="text-align: center; margin-top: 20px;">
    <button type="button" onclick="window.location.href='/'">
      Volver al inicio
    </button>
  </div>

  <!-- ===== MODAL NUEVO AUTOR ===== -->
  <div class="modal-bg" id="modalNuevoAutor">
    <div class="modal-card">
      <h3>‚ûï Registrar nuevo autor</h3>
      <div class="modal-grid">
        <label>Documento:</label>
        <div>
          <input type="text" id="na_documento" required pattern="\d+">
          <div id="msgDocumento" class="msg-validacion"></div>
        </div>

        <label>Nombre completo:</label>
        <input type="text" id="na_nombre" required>

        <label>Pseud√≥nimo:</label>
        <input type="text" id="na_pseudonimo">

        <label>Sexo:</label>
        <select id="na_sexo">
          <option value="">Seleccione una opci√≥n</option>
          <option value="Masculino">Masculino</option>
          <option value="Femenino">Femenino</option>
          <option value="Otro">Otro</option>
        </select>

        <label>Perfil:</label>
        <input type="text" id="na_perfil">

        <label>Nacionalidad:</label>
        <input type="text" id="na_nacionalidad">

        <label>Correo:</label>
        <input type="email" id="na_correo">

        <label>Nivel de formaci√≥n:</label>
        <input type="text" id="na_formacion">

        <label>Rector√≠a normalizada:</label>
        <input type="text" id="na_rectoria_normalizada">

        <label>Rector√≠a original:</label>
        <input type="text" id="na_rectoria_original">

        <label>Centro universitario:</label>
        <input type="text" id="na_centro">

        <label>Escuela / facultad:</label>
        <input type="text" id="na_facultad">

        <label>Programa acad√©mico:</label>
        <input type="text" id="na_programa">

        <label>Filiaci√≥n:</label>
        <input type="text" id="na_filiacion">

        <label>Pa√≠s filiaci√≥n:</label>
        <input type="text" id="na_pais">

        <label>¬øEs investigador?</label>
        <select id="na_investigador">
          <option value="">Seleccione...</option>
          <option value="true">S√≠</option>
          <option value="false">No</option>
        </select>
      </div>

      <div class="modal-actions">
        <button type="button" id="btnCancelarAutor" class="btn-ghost">Cancelar</button>
        <button type="button" id="btnGuardarAutor">Guardar Autor</button>
      </div>
    </div>
  </div>
  <!-- ===== FIN MODAL ===== -->

  <script>
    // ====== Helpers ======
    const $ = (sel) => document.querySelector(sel);
    const el = (html) => { const tmp = document.createElement('div'); tmp.innerHTML = html.trim(); return tmp.firstChild; };
    const debounce = (fn, ms=350) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), ms); }; };

    // ====== Autocomplete autores ======
    const buscador = $("#buscadorAutor");
    const panelSug = $("#sugerenciasAutores");
    const contChips = $("#autoresSeleccionados");
    const autoresSel = new Map(); // key: documento, value: {documento, nombre}

    function renderChips(){
      contChips.innerHTML = "";
      for (const a of autoresSel.values()){
        const chip = el(`
          <span class="chip">
            <strong>${a.nombre}</strong> <small>(${a.documento})</small>
            <button type="button" aria-label="Quitar">x</button>
          </span>
        `);
        chip.querySelector("button").addEventListener("click", () => {
          autoresSel.delete(a.documento);
          renderChips();
        });
        contChips.appendChild(chip);
      }
    }

    async function buscarAutores(q){
      if(!q || q.length < 2){
        panelSug.style.display = "none";
        panelSug.innerHTML = "";
        return;
      }
      try{
        const r = await fetch(`/api/autores?q=${encodeURIComponent(q)}`);
        const data = await r.json();
        panelSug.innerHTML = "";

        const normalizados = (Array.isArray(data) ? data : []).map(item => {
          return { documento: item.documento || "", nombre: item.nombre || "" };
        }).filter(x => x.documento && x.nombre);

        if(!normalizados.length){
          panelSug.style.display = "none";
          return;
        }
        normalizados.forEach(a => {
          const item = el(`<div class="sug-item">${a.documento} - ${a.nombre}</div>`);
          item.addEventListener("click", () => {
            autoresSel.set(a.documento, a);
            renderChips();
            panelSug.style.display = "none";
            buscador.value = "";
          });
          panelSug.appendChild(item);
        });
        panelSug.style.display = "block";
      }catch(e){
        console.error("Error buscando autores", e);
        panelSug.style.display = "none";
      }
    }

    buscador.addEventListener("input", debounce(() => buscarAutores(buscador.value.trim()), 300));
    document.addEventListener("click", (e) => {
      if(!panelSug.contains(e.target) && e.target !== buscador){
        panelSug.style.display = "none";
      }
    });

    // ====== Modal nuevo autor ======
    const modal = $("#modalNuevoAutor");
    const btnNuevo = $("#btnAbrirNuevoAutor");
    const btnCancel = $("#btnCancelarAutor");
    const btnSaveAutor = $("#btnGuardarAutor");

    const inputDoc = $("#na_documento");
    const msgDoc = $("#msgDocumento"); // <div id="msgDocumento"> debajo del input documento

    btnNuevo.addEventListener("click", () => { 
      modal.style.display = "flex"; 
      resetDocValidation();
    });
    btnCancel.addEventListener("click", () => { modal.style.display = "none"; });

    function resetDocValidation(){
      msgDoc.textContent = "";
      msgDoc.className = "";
      inputDoc.style.borderColor = "";
      btnSaveAutor.disabled = false;
    }

    async function validarDocumento(doc){
      if(!doc){ resetDocValidation(); return; }
      try {
        const check = await fetch(`/check_autor/${encodeURIComponent(doc)}`);
        const resCheck = await check.json();
        if (resCheck.exists) {
          msgDoc.textContent = "‚ùå Ya existe un autor con este documento";
          msgDoc.className = "msg-error";
          inputDoc.style.borderColor = "red";
          btnSaveAutor.disabled = true;
        } else {
          msgDoc.textContent = "‚úÖ Documento disponible";
          msgDoc.className = "msg-ok";
          inputDoc.style.borderColor = "green";
          btnSaveAutor.disabled = false;
        }
      } catch (e) {
        console.error("Error validando documento", e);
      }
    }

    inputDoc.addEventListener("input", () => {
      const doc = inputDoc.value.trim();
      if (doc.length > 3) validarDocumento(doc);
      else resetDocValidation();
    });

    btnSaveAutor.addEventListener("click", async () => {
      const doc = $("#na_documento").value.trim();
      const nombre = $("#na_nombre").value.trim();

      if (!doc || !nombre) {
        alert("Documento y nombre son obligatorios.");
        return;
      }

      if (btnSaveAutor.disabled) {
        alert("‚ö†Ô∏è Corrija el documento antes de continuar.");
        return;
      }

      // Si no existe ‚Üí a√±adir solo a lista local
      autoresSel.set(doc, { documento: doc, nombre });
      renderChips();
      modal.style.display = "none";
      alert("‚úÖ Autor agregado localmente. Se guardar√° al registrar la publicaci√≥n.");
    });

    // ====== Form submit publicaci√≥n ======
    document.getElementById("formPublicacion").addEventListener("submit", function (e) {
      e.preventDefault();
      const form = document.getElementById("formPublicacion");
      const formData = new FormData(form);

      // Generar c√≥digo por publicaci√≥n
      const isbn = (formData.get("isbn") || "").replace(/\D/g, "");
      const eisbn = (formData.get("eisbn") || "").replace(/\D/g, "");
      let codigo = "";
      if (isbn && eisbn) {
        codigo = isbn.slice(-4) + eisbn.slice(-4);
      } else if (isbn) {
        codigo = isbn.slice(-4) + "0000";
      } else if (eisbn) {
        codigo = eisbn.slice(-4) + "0000";
      }
      if (codigo.length === 8) {
        codigo = codigo.slice(0, 4) + "-" + codigo.slice(4);
      }
      document.getElementById("codigo_publicacion").value = codigo;
      formData.set("codigo_publicacion", codigo);

      const datos = Object.fromEntries(formData.entries());
      datos.autores = Array.from(autoresSel.values());

      if (datos.origen === "Otro" && (datos.origen_otro || "").trim()) {
        datos.origen = datos.origen_otro.trim();
      }
      delete datos.origen_otro;

      fetch("/guardar-publicacion", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(datos)
      })
      .then(res => res.json())
      .then(data => {
        const mensaje = document.getElementById("mensaje");
        if (data.status === "ok") {
          const codigo = document.getElementById("codigo_publicacion").value;
          mensaje.innerHTML = `‚úÖ Publicaci√≥n registrada correctamente.<br><strong>üìò C√≥digo por Publicaci√≥n:</strong> ${codigo}`;
          mensaje.style.color = "green";
          document.getElementById("formPublicacion").reset();
          document.getElementById("codigo_publicacion").value = "";
          autoresSel.clear();
          renderChips();
        } else {
          mensaje.textContent = "‚ö†Ô∏è Error inesperado.";
          mensaje.style.color = "orange";
        }
      })
      .catch(err => {
        console.error(err);
        const mensaje = document.getElementById("mensaje");
        mensaje.textContent = "‚ö†Ô∏è Error de red o del servidor.";
        mensaje.style.color = "orange";
      });
    });
  </script>

</body>
</html>
