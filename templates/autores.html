<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Autores</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f5f5;
      margin: 40px;
      color: #333;
    }

    h2, h3 {
      color: #0066cc;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }

    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    button {
      background-color: #0066cc;
      color: white;
      padding: 10px 20px;
      margin-top: 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button{
      padding: 12px 24px;
      background-color: #0066cc;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }

    button:hover {
      background-color: #004c99;
    }

    #respuesta {
      margin-top: 15px;
      font-weight: bold;
    }

    #formularioNuevo {
      background-color: white;
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 6px;
      max-width: 700px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    hr {
      margin: 30px 0;
    }
  </style>
</head>
<body>
  <h2>Buscar autor registrado</h2>

  <label>Escribe tu nombre o número de documento:</label>
  <input type="text" id="buscador" list="sugerencias">
  <datalist id="sugerencias"></datalist><br><br>

  <button onclick="verificar()">Verificar</button>

  <p id="respuesta"></p>

  <hr>

  <div id="formularioNuevo" style="display: none;">
    <h3>Formulario de Registro</h3>
    <form id="formAutor">
      <label>Documento:</label>
      <input type="text" id="documento" required>

      <label>Nombre autor:</label>
      <input type="text" id="nombre" required>

      <label>Pseudónimo:</label>
      <input type="text" id="pseudonimo" required>

      <label>Sexo:</label>
      <select id="sexo" required>
        <option value="">Seleccione una opción</option>
        <option value="Masculino">Masculino</option>
        <option value="Femenino">Femenino</option>
        <option value="Otro">Otro</option>
      </select>

      <label>Perfil:</label>
      <input type="text" id="perfil" required>

      <label>Nacionalidad:</label>
      <input type="text" id="nacionalidad" required>

      <label>Correo:</label>
      <input type="email" id="correo" required>

      <label>Nivel de formación:</label>
      <input type="text" id="formacion" required>

      <label>Filiación:</label>
      <input type="text" id="filiacion" required>

      <label>País filiación:</label>
      <input type="text" id="pais" required>

      <label>¿Es investigador?:</label>
      <input type="text" id="investigador" required>

      <label>Rectoría:</label>
      <input type="text" id="rectoria_original" required>

      <label>Centro universitario:</label>
      <input type="text" id="centro">

      <label>Escuela / facultad:</label>
      <input type="text" id="facultad" required>

      <label>Programa académico:</label>
      <input type="text" id="programa">

      <label>Fecha último diligenciamiento:</label>
      <input type="text" id="fecha" required>

      <button type="submit">Guardar</button>
    </form>
  </div>
  
  <div style="text-align: center; margin-top: 20px;">
    <button type="button" onclick="window.location.href='/'">
      Volver al inicio
    </button>
  </div>
  
  <script>
    const input = document.getElementById("buscador");
    const datalist = document.getElementById("sugerencias");
    const respuesta = document.getElementById("respuesta");
    const formDiv = document.getElementById("formularioNuevo");

    input.addEventListener("input", async () => {
      const q = input.value;
      if (q.length < 2) return;

      const res = await fetch(`/buscar?q=${encodeURIComponent(q)}`);
      const sugerencias = await res.json();

      datalist.innerHTML = "";
      sugerencias.forEach(nombre => {
        const option = document.createElement("option");
        option.value = nombre;
        datalist.appendChild(option);
      });
    });

    async function verificar() {
        const valorIngresado = input.value.trim().toLowerCase();

        // Separar si viene en formato "documento - nombre"
        let partes = valorIngresado.split(" - ");
        const valorBuscado = partes.length > 1 ? partes[1] : valorIngresado;

        const res = await fetch(`/buscar?q=${encodeURIComponent(valorBuscado)}`);
        const sugerencias = await res.json();

        const encontrado = sugerencias.some(item =>
            item.toLowerCase().includes(valorBuscado)
        );

        if (encontrado) {
            respuesta.textContent = "✅ Ya estás registrado.";
            formDiv.style.display = "none";
        } else {
            respuesta.textContent = "❌ No estás en la base. Completa el formulario.";
            formDiv.style.display = "block";
            document.getElementById("nombre").value = valorBuscado;
        }
    }

    document.getElementById("formAutor").addEventListener("submit", async (e) => {
        e.preventDefault();

        // Validación manual adicional
        const documento = document.getElementById("documento").value.trim();
        const correo = document.getElementById("correo").value.trim();

        if (!/^\d+$/.test(documento)) {
            respuesta.textContent = "❌ El número de documento solo debe contener dígitos.";
            return;
        }

        if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(correo)) {
            respuesta.textContent = "❌ Por favor ingresa un correo válido.";
            return;
        }

        const datos = {
            documento,
            nombre: document.getElementById("nombre").value,
            pseudonimo: document.getElementById("pseudonimo").value,
            sexo: document.getElementById("sexo").value,
            perfil: document.getElementById("perfil").value,
            nacionalidad: document.getElementById("nacionalidad").value,
            correo,
            formacion: document.getElementById("formacion").value,
            rectoria_original: document.getElementById("rectoria_original").value,
            centro: document.getElementById("centro").value,
            facultad: document.getElementById("facultad").value,
            programa: document.getElementById("programa").value,
            filiacion: document.getElementById("filiacion").value,
            pais: document.getElementById("pais").value,
            investigador: document.getElementById("investigador").value,
            fecha: document.getElementById("fecha").value
        };

        const res = await fetch("/guardar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(datos)
        });

        const resultado = await res.json();
        respuesta.textContent = resultado.mensaje;

        if (resultado.status === "ok") {
            document.getElementById("formAutor").reset();
            formDiv.style.display = "none";
        }
    });

  </script>
</body>
</html>

